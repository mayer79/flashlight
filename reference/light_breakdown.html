<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Variable Contribution Breakdown for Single Observation — light_breakdown • flashlight</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png"><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="Variable Contribution Breakdown for Single Observation — light_breakdown"><meta property="og:description" content="Calculates sequential additive variable contributions (approximate SHAP) to
the prediction of a single observation, see Gosiewska and Biecek (see reference)
and the details below."><meta property="og:image" content="/logo.png"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">flashlight</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.9.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../articles/flashlight.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/mayer79/flashlight/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Variable Contribution Breakdown for Single Observation</h1>
    <small class="dont-index">Source: <a href="https://github.com/mayer79/flashlight/blob/HEAD/R/light_breakdown.R" class="external-link"><code>R/light_breakdown.R</code></a></small>
    <div class="hidden name"><code>light_breakdown.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Calculates sequential additive variable contributions (approximate SHAP) to
the prediction of a single observation, see Gosiewska and Biecek (see reference)
and the details below.</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">light_breakdown</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for default</span></span>
<span><span class="fu">light_breakdown</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for flashlight</span></span>
<span><span class="fu">light_breakdown</span><span class="op">(</span></span>
<span>  <span class="va">x</span>,</span>
<span>  <span class="va">new_obs</span>,</span>
<span>  data <span class="op">=</span> <span class="va">x</span><span class="op">$</span><span class="va">data</span>,</span>
<span>  by <span class="op">=</span> <span class="va">x</span><span class="op">$</span><span class="va">by</span>,</span>
<span>  v <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  visit_strategy <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"importance"</span>, <span class="st">"permutation"</span>, <span class="st">"v"</span><span class="op">)</span>,</span>
<span>  n_max <span class="op">=</span> <span class="cn">Inf</span>,</span>
<span>  n_perm <span class="op">=</span> <span class="fl">20</span>,</span>
<span>  seed <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  use_linkinv <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  description <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  digits <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for multiflashlight</span></span>
<span><span class="fu">light_breakdown</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>
    <dl><dt>x</dt>
<dd><p>An object of class "flashlight" or "multiflashlight".</p></dd>


<dt>...</dt>
<dd><p>Further arguments passed to <code><a href="https://rdrr.io/r/base/formatc.html" class="external-link">prettyNum()</a></code> to format numbers
in description text.</p></dd>


<dt>new_obs</dt>
<dd><p>One single new observation to calculate variable attribution for.
Needs to be a <code>data.frame</code> of same structure as <code>data</code>.</p></dd>


<dt>data</dt>
<dd><p>An optional <code>data.frame</code>.</p></dd>


<dt>by</dt>
<dd><p>An optional vector of column names used to filter <code>data</code>
for rows with equal values in "by" variables as <code>new_obs</code>.</p></dd>


<dt>v</dt>
<dd><p>Vector of variable names to assess contribution for.
Defaults to all except those specified by "y", "w" and "by".</p></dd>


<dt>visit_strategy</dt>
<dd><p>In what sequence should variables be visited?
By "importance", by <code>n_perm</code> "permutation" or as "v" (see Details).</p></dd>


<dt>n_max</dt>
<dd><p>Maximum number of rows in <code>data</code> to consider in the reference data.
Set to lower value if <code>data</code> is large.</p></dd>


<dt>n_perm</dt>
<dd><p>Number of permutations of random visit sequences.
Only used if <code>visit_strategy = "permutation"</code>.</p></dd>


<dt>seed</dt>
<dd><p>An integer random seed used to shuffle rows if <code>n_max</code>
is smaller than the number of rows in <code>data</code>.</p></dd>


<dt>use_linkinv</dt>
<dd><p>Should retransformation function be applied? Default is <code>FALSE</code>.</p></dd>


<dt>description</dt>
<dd><p>Should descriptions be added? Default is <code>TRUE</code>.</p></dd>


<dt>digits</dt>
<dd><p>Passed to <code><a href="https://rdrr.io/r/base/formatc.html" class="external-link">prettyNum()</a></code> to format numbers in description text.</p></dd>

</dl></div>
    <div id="value">
    <h2>Value</h2>
    

<p>An object of class "light_breakdown" with the following elements:</p><ul><li><p><code>data</code> A tibble with results. Can be used to build fully customized
visualizations. Column names can be controlled by <code>options(flashlight.column_name)</code>.</p></li>
<li><p><code>by</code> Same as input <code>by</code>.</p></li>
</ul></div>
    <div id="details">
    <h2>Details</h2>
    <p>The breakdown algorithm works as follows: First, the visit order
\((x_1, ..., x_m)\) of the variables <code>v</code> is specified.
Then, in the query <code>data</code>, the column \(x_1\) is set to the value of \(x_1\)
of the single observation <code>new_obs</code> to be explained.
The change in the (weighted) average prediction on <code>data</code> measures the
contribution of \(x_1\) on the prediction of <code>new_obs</code>.
This procedure is iterated over all \(x_i\) until eventually, all rows
in <code>data</code> are identical to <code>new_obs</code>.</p>
<p>A complication with this approach is that the visit order is relevant,
at least for non-additive models. Ideally, the algorithm could be repeated
for all possible permutations of <code>v</code> and its results averaged per variable.
This is basically what SHAP values do, see the reference below for an explanation.
Unfortunately, there is no efficient way to do this in a model agnostic way.</p>
<p>We offer two visit strategies to approximate SHAP:</p><ol><li><p>"importance": Using the short-cut described in the reference below:
The variables are sorted by the size of their contribution in the same way as the
breakdown algorithm but without iteration, i.e., starting from the original query
data for each variable \(x_i\).</p></li>
<li><p>"permutation": Averages contributions from a small number of random permutations
of <code>v</code>.</p></li>
</ol><p>Note that the minimum required elements in the (multi-)flashlight are a
"predict_function", "model", and "data". The latter can also directly be passed to
<code>light_breakdown()</code>. Note that by default, no retransformation function is applied.</p>
    </div>
    <div id="methods-by-class-">
    <h2>Methods (by class)</h2>
    
<ul><li><p><code>light_breakdown(default)</code>: Default method not implemented yet.</p></li>
<li><p><code>light_breakdown(flashlight)</code>: Variable attribution to single observation
for a flashlight.</p></li>
<li><p><code>light_breakdown(multiflashlight)</code>: Variable attribution to single observation
for a multiflashlight.</p></li>
</ul></div>
    <div id="references">
    <h2>References</h2>
    <p>A. Gosiewska and P. Biecek (2019). IBREAKDOWN: Uncertainty of model explanations
for non-additive predictive models. ArXiv.</p>
    </div>
    <div id="see-also">
    <h2>See also</h2>
    <div class="dont-index"><p><code><a href="plot.light_breakdown.html">plot.light_breakdown()</a></code></p></div>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">Sepal.Length</span> <span class="op">~</span> <span class="va">.</span> <span class="op">+</span> <span class="va">Petal.Length</span><span class="op">:</span><span class="va">Species</span>, data <span class="op">=</span> <span class="va">iris</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">fl</span> <span class="op">&lt;-</span> <span class="fu"><a href="flashlight.html">flashlight</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">fit</span>, label <span class="op">=</span> <span class="st">"lm"</span>, data <span class="op">=</span> <span class="va">iris</span>, y <span class="op">=</span> <span class="st">"Sepal.Length"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu">light_breakdown</span><span class="op">(</span><span class="va">fl</span>, new_obs <span class="op">=</span> <span class="va">iris</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> I am an object of class light_breakdown </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> data.frames:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  data </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #949494;"># A tibble: 6 × 6</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    step variable     after before label description             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">1</span>     0 baseline      5.84   5.84 lm    average in data: 5.8    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">2</span>     1 Petal.Length  3.86   5.84 lm    Petal.Length = 1.4: -2  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">3</span>     2 Species       4.53   3.86 lm    Species = setosa: +0.67 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">4</span>     3 Petal.Width   4.81   4.53 lm    Petal.Width = 0.2: +0.28</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">5</span>     4 Sepal.Width   5.03   4.81 lm    Sepal.Width = 3.5: +0.22</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">6</span>     5 prediction    5.03   5.03 lm    prediction: +0          </span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Michael Mayer.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer></div>

  


  

  </body></html>

